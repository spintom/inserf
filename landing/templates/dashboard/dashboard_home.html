{% extends 'dashboard/admin_base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
  <div class="col">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <p class="text-muted small mb-2">Total Orders</p>
        <h2 class="card-title text-primary">{{ total_orders }}</h2>
        <div class="mt-3 text-primary-emphasis">
          <i class="fas fa-shopping-cart fa-2x"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <p class="text-muted small mb-2">Products in Stock</p>
        <h2 class="card-title text-info">{{ total_products }}</h2>
        <div class="mt-3 text-info-emphasis">
          <i class="fas fa-box fa-2x"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <p class="text-muted small mb-2">Clients</p>
        <h2 class="card-title text-success">{{ total_clients }}</h2>
        <div class="mt-3 text-success-emphasis">
          <i class="fas fa-users fa-2x"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-3">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-pie text-primary me-2"></i>
          Orders by Status
        </h5>
      </div>
      <div class="card-body">
        {% if orders_by_status %}
          <div class="chart-container" style="position: relative; height: 250px;">
            <canvas id="ordersChart"></canvas>
          </div>
        {% else %}
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-lg mb-3"></i>
            <p>No order data available.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-bar text-info me-2"></i>
          Stock by Category
        </h5>
      </div>
      <div class="card-body">
        {% if stock_by_category %}
          <div class="chart-container" style="position: relative; height: 250px;">
            <canvas id="stockChart"></canvas>
          </div>
        {% else %}
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-lg mb-3"></i>
            <p>No stock data available.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // Wait for DOM and all scripts (including Chart.js) to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Make sure Chart.js is defined before using it
    if (typeof Chart !== 'undefined') {
      {% if orders_by_status %}
      const ordersChart = document.getElementById('ordersChart').getContext('2d');
      new Chart(ordersChart, {
          type: 'doughnut',
          data: {
              labels: [{% for item in orders_by_status %}'{{ item.status|capfirst }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
              datasets: [{
                  data: [{% for item in orders_by_status %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                  backgroundColor: ['#0d6efd', '#20c997', '#ffc107', '#dc3545'],
                  borderWidth: 0
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });
      {% endif %}

      {% if stock_by_category %}
      const stockChart = document.getElementById('stockChart').getContext('2d');
      new Chart(stockChart, {
          type: 'bar',
          data: {
              labels: [{% for item in stock_by_category %}'{{ item.product__category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
              datasets: [{
                  label: 'Stock',
                  data: [{% for item in stock_by_category %}{{ item.total_stock }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                  backgroundColor: '#0dcaf0',
                  borderRadius: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      grid: {
                          display: true,
                          color: 'rgba(0,0,0,0.05)'
                      }
                  },
                  x: {
                      grid: {
                          display: false
                      }
                  }
              }
          }
      });
      {% endif %}
    } else {
      console.error('Chart.js is not loaded. Charts will not be displayed.');
    }
  });
</script>

{% endblock %}
